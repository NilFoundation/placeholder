# Proof producer for the =nil; Proof Market
This repository contains the proof producer for the =nil;
[Proof Market](https://proof.market/), which is a part of the =nil;
[zkllvm toolchain](https://github.com/NilFoundation/zkLLVM) for zk-enabled
applications development.

# How to use

The input for the proof producer is a circified version of the algorithm to be
proven. This circified version of the algorithm is generated by the
[zkllvm](https://raw.githubusercontent.com/NilFoundation/zkllvm) toolchain.

Typically, you want to use the proof producer to participate in the =nil;
Proof Market. In this case, you need to have a valid account on the =nil;
Proof Market, which you can create through the
[Proof Market web interface](https://proof.market/) or by using the
[Proof Market CLI](https://github.com/NilFoundation/proof-market-toolchain/).

# Installation

All parts of the zkLLVM toolchain are distributed in form of deb packages.
To install them, you need to add the =nil; repository to your systems package
manager:

```bash
echo 'deb [trusted=yes]  http://deb.nil.foundation/ubuntu/ all main' >>/etc/apt/sources.list
apt update
```

Then, you can install the proof producer by running:

```bash
apt install proof-producer
```

# Usage

The proof producer is a command line tool. To see the list of available
options, run:

```bash
proof-generator --help
```

To produce a proof, you need to provide the proof producer with the file with
the circuit definition and the assignment table with the values of the
execution trace. You generate them from the
[zkllvm examples](https://github.com/NilFoundation/zkLLVM) or download the
existing ones using the
[Proof Market CLI](https://github.com/NilFoundation/proof-market-toolchain/).

When you have the circuit definition and the assignment table, you can produce
a proof by running:

```bash
proof-generator --circuit <circuit-file> --assignment <assignment-file> --proof <proof-file>
```

# Building from source

# Sample calls to proof-producer

In all the calls you can change the executable name from
proof-producer-single-threaded to proof-producer-multi-threaded to run on all
the CPUs of your machine.

## Using proof-producer to generate and verify a single proof

Generate a proof and verify it:
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --circuit="circuit.crct" \
    --assignment-table="assignment.tbl" \
    --proof="proof.bin" -q 10
```

Making a call to preprocessor:

```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="preprocess" \
    --circuit="circuit.crct" \
    --assignment-table="assignment.tbl" \
    --common-data="preprocessed_common_data.dat" \
    --preprocessed-data="preprocessed.dat" \
    --commitment-state-file="commitment_state.dat" \
    --assignment-description-file="assignment-description.dat" \
    -q 10
```

Making a call to prover:

```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="prove" \
    --circuit="circuit.crct" \
    --assignment-table="assignment.tbl" \
    --common-data="preprocessed_common_data.dat" \
    --preprocessed-data="preprocessed.dat" \
    --commitment-state-file="commitment_state.dat" \
    --proof="proof.bin" \
    -q 10
```

Verify generated proof:
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="verify" \
    --circuit="circuit.crct" \
    --common-data="preprocessed_common_data.dat" \
    --proof="proof.bin" \
    --assignment-description-file="assignment-description.dat" \
    -q 10
```

## Using proof-producer to generate and verify an aggregated proof.

Partial proof, ran on each prover.
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage partial-prove \
    --grind-param 16 \
    --max-quotient-chunks 10 \
    --circuit           circuits-and-assignments/$CIRCUIT/circuit.crct \
    --assignment-table  circuits-and-assignments/$CIRCUIT/assignment.tbl \
    --common-data                  $CIRCUIT-common_data.dat \
    --preprocessed-data            $CIRCUIT-preprocessed.dat \
    --commitment-state-file        $CIRCUIT-commitment_state.dat \
    --assignment-description-file  $CIRCUIT-assignment-description.dat \
    --challenge-file               $CIRCUIT-challenge.dat \
    --theta-power-file             $CIRCUIT-theta-power.txt \
    --proof                        $CIRCUIT-proof.dat \
    --json                         $CIRCUIT-proof.json
```

Aggregate challenges, done once on the main prover.
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="generate-aggregated-challenge" \
    --input-challenge-files challenge1.dat \
    --input-challenge-files challenge2.dat \
    --aggregated-challenge-file="aggregated_challenge.dat"
```

Compute polynomial combined_Q, done on each prover. Please notice that the caller must provide the correct value of --combined-Q-starting-power, which can be taken from "$CIRCUIT-theta-power.txt" generated on stage "partial-prove".
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="compute-combined-Q" \
    --aggregated-challenge-file="aggregated_challenge.dat" \
    --combined-Q-starting-power=0  \
    --commitment-state-file="$CIRCUIT-commitment_state.dat" \
    --combined-Q-polynomial-file="$CIRCUIT-combined-Q.dat"
```

Compute aggregated FRI proof done once on the main prover. This is a part of the complete proof. The '--assignment-description-file' can point to any description file, since only the number of rows matters.
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="aggregated-FRI" \
    --assignment-description-file="assignment-description.dat" \
    --aggregated-challenge-file="aggregated_challenge.dat" \
    --input-combined-Q-polynomial-files "$CIRCUIT1-combined-Q.dat" "$CIRCUIT2_combined-Q.dat" \
    --proof="aggregated_FRI_proof.bin" \
    --proof-of-work-file="POW.dat" \
    --consistency-checks-challenges-file="challenges.dat"
```

Compute LPC consistency check proofs for polynomial combined_Q, done on each prover.
```bash
./build/bin/proof-producer/proof-producer-single-threaded \
    --stage="consistency-checks" \
    --commitment-state-file="$CIRCUIT-commitment_scheme_state.dat" \
    --combined-Q-polynomial-file="$CIRCUIT-combined-Q.dat" \
    --consistency-checks-challenges-file="challenges.dat" \
    --proof="$CIRCUIT-LPC_consistency_check_proof.bin"
```

Merge proofs into one final proof:
```bash

bin/proof-producer/proof-producer-single-threaded \
    --stage merge-proofs  \
    --partial-proof $CIRCUIT1-proof.dat \
    --partial-proof $CIRCUIT2-proof.dat \
    --initial-proof $CIRCUIT1-LPC_consistency_check_proof.bin \
    --initial-proof $CIRCUIT2-LPC_consistency_check_proof.bin \
    --aggregated-FRI-proof aggregated_FRI_proof.bin \
    --proof final-proof.dat
```

